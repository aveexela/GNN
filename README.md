# Graph-RAG + GNN QA System

## Описание проекта
Проект реализует Retrieval-Augmented Generation (RAG), улучшенный с помощью графовых методов (Graph Neural Networks, GNN),  
для автоматического ответа на вопросы по курсу **Graph Neural Networks (GNN)**.

Основная идея — использование графа смысловых связей между текстовыми чанками,  
чтобы улучшить этап извлечения контекста (retrieval) и повысить качество ответов модели.

---

## Архитектура решения

### 1. Baseline RAG
- Разбиение лекций `.docx` и `.pdf` на текстовые чанки.  
- Генерация эмбеддингов с помощью `openai/text-embedding-3-small`.  
- Поиск релевантных фрагментов по косинусному сходству.  
- Генерация ответа моделью `openai/gpt-4.1-mini`.  

### 2. Graph-RAG (с GNN)
- Формирование графа между чанками по их семантическому сходству.  
- Обучение GNN (GraphSAGE) для построения новых графовых эмбеддингов, которые учитывают структуру документа.  
- Multi-hop retrieval: при поиске контекста извлекаются не только ближайшие чанки, но и их соседи в графе.  
- Генерация ответа LLM с использованием расширенного контекста.

---

## Построение графа

После разбиения текста на смысловые чанки (около 380) создается граф:
- Каждый узел — это чанк текста.  
- Ребра соединяют узлы, если косинусное сходство их эмбеддингов превышает 0.8.  
- Граф содержит около 140 рёбер.  

Формально граф задается как  
$$
G = (V, E), \quad |V| = 380, \quad |E| \approx 140
$$

Это позволяет выполнять multi-hop retrieval и учитывать более широкий контекст при генерации ответов.

---

## Модель GNN

Используется двухслойная архитектура GraphSAGE с функцией агрегации вида:

$$
h_v^{(k+1)} = \sigma \left(W^{(k)} \cdot \text{AGGREGATE}\left(\{h_v^{(k)}\} \cup \{h_u^{(k)} | u \in N(v)\}\right)\right)
$$

- Вход: эмбеддинги чанков из `text-embedding-3-small`  
- Выход: новые графовые эмбеддинги размерности 128  
- Цель: сделать представления соседних чанков более близкими  
- Функция потерь: контрастивная, минимизирующая различие между связанными узлами

После обучения графовые эмбеддинги учитывают структуру документа и смысловые зависимости между фрагментами.

---

## Как граф улучшает RAG

Граф используется на этапе retrieval:

1. **Baseline RAG**: выбирает top-k чанков по косинусному сходству векторных эмбеддингов.  
2. **Graph-RAG**:  
   - Преобразует чанки в графовые эмбеддинги с учетом соседей.  
   - Извлекает top-k кандидатов в пространстве GNN-эмбеддингов.  
   - Расширяет контекст, включая соседей на 1–2 шага по графу.  
   - Передает расширенный контекст в LLM для генерации ответа.

Такой подход обеспечивает более связные и информативные ответы, особенно на вопросы, требующие контекста из нескольких частей курса.

---

## Назначение файлов

| Файл | Назначение |
|------|-------------|
| `baseline.ipynb` | Ноутбук с базовой RAG-системой без графов |
| `rag+gnn.ipynb` | Основной ноутбук с реализацией Graph-RAG и GNN |
| `compare.ipynb` | Сравнение baseline и Graph-RAG по BERTScore |
| `QA_dataset.xlsx` | Исходный набор вопросов по курсу |
| `QA_dataset_answered_baseline.xlsx` | Ответы, сгенерированные базовым RAG |
| `QA_dataset_answered.xlsx` | Ответы, сгенерированные Graph-RAG |
| `QA_dataset_comparison.xlsx` | Таблица сравнения baseline и Graph-RAG |
| `README.md` | Описание проекта, файлов и результатов |

---

## Как запустить

Запуск через ноутбук
